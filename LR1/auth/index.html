<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Authentication - Лабораторные работы</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Authentication";
        var mkdocs_page_input_path = "LR1\\auth.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Лабораторные работы
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">LR1</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../">Home</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../practices/">Practices</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../leetcode/">Leetcode</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Task</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Authentication</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#_2">Описание</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_3">Код</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../db/">Database</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../endpoints/">Endpoints</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../main/">Main</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../models/">Models</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LR2</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../LR2/">Home</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../LR2/leetcode/">Leetcode</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Task 1</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../LR2/task1/async/">AsyncIO</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../LR2/task1/thread/">Threading</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../LR2/task1/multiproc/">Multiprocessing</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Task 2</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../LR2/task2/db/">Database</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../LR2/task2/url/">URLs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../LR2/task2/parse_async/">AsyncIO</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../LR2/task2/parse_thread/">Threading</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../LR2/task2/parse_multiproc/">Multiprocessing</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LR3</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../LR3/">Home</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../LR3/leetcode/">Leetcode</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Лабораторные работы</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">LR1</li>
          <li class="breadcrumb-item">Task</li>
      <li class="breadcrumb-item active">Authentication</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">Модуль аутентификации</h1>
<p>Этот модуль предоставляет функционал для аутентификации пользователей через токены JWT.</p>
<h2 id="_2">Описание</h2>
<p>Модуль содержит функции для регистрации, входа и аутентификации пользователей с использованием токенов JWT.</p>
<h2 id="_3">Код</h2>
<pre><code class="language-python">from fastapi import APIRouter
from models import UserBase, User, UserShow, ChangePassword
import datetime
from fastapi import Security, HTTPException, Depends
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from passlib.context import CryptContext
import jwt
from starlette import status
from db import get_session
from sqlmodel import select

security = HTTPBearer()
pwd_context = CryptContext(schemes=[&quot;bcrypt&quot;])
secret_key = &quot;supersecret&quot;


def get_password_hash(password):
    return pwd_context.hash(password)


def verify_password(password, hashed_password):
    return pwd_context.verify(password, hashed_password)


def encode_token(user_id):
    payload = {
        &quot;exp&quot;: datetime.datetime.utcnow() + datetime.timedelta(hours=8),
        &quot;iat&quot;: datetime.datetime.utcnow(),
        &quot;sub&quot;: user_id,
    }
    return jwt.encode(payload, secret_key, algorithm=&quot;HS256&quot;)


def decode_token(token):
    try:
        payload = jwt.decode(token, secret_key, algorithms=[&quot;HS256&quot;])
        return payload[&quot;sub&quot;]
    except jwt.ExpiredSignatureError:
        raise HTTPException(status_code=401, detail=&quot;Expired signature&quot;)
    except jwt.InvalidTokenError:
        raise HTTPException(status_code=401, detail=&quot;Invalid token&quot;)


def auth_wrapper(auth: HTTPAuthorizationCredentials = Security(security)):
    return decode_token(auth.credentials)


def get_current_user(
    auth: HTTPAuthorizationCredentials = Security(security),
    session=Depends(get_session),
):
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail=&quot;Could not validate credentials&quot;,
    )
    username = decode_token(auth.credentials)
    if username is None:
        raise credentials_exception
    user = session.exec(select(User).where(User.username == username)).first()
    if user is None:
        raise credentials_exception
    return user


auth_router = APIRouter()


@auth_router.post(&quot;/register&quot;, status_code=201)
def register(user: UserBase, session=Depends(get_session)):
    users = session.exec(select(User)).all()
    if any(x.username == user.username for x in users):
        raise HTTPException(status_code=400, detail=&quot;Username is taken&quot;)
    hashed_pwd = get_password_hash(user.password)
    user = User(username=user.username, password=hashed_pwd)
    session.add(user)
    session.commit()
    return {&quot;status&quot;: 201, &quot;message&quot;: &quot;Created&quot;}


@auth_router.post(&quot;/login&quot;)
def login(user: UserBase, session=Depends(get_session)):
    user_found = session.exec(
        select(User).where(User.username == user.username)
    ).first()
    if not user_found:
        raise HTTPException(status_code=401, detail=&quot;Invalid username and/or password&quot;)
    verified = verify_password(user.password, user_found.password)
    if not verified:
        raise HTTPException(status_code=401, detail=&quot;Invalid username and/or password&quot;)
    token = encode_token(user_found.username)
    return {&quot;token&quot;: token}


@auth_router.get(&quot;/user&quot;, response_model=UserShow)
def get_current_user(user: User = Depends(get_current_user)) -&gt; User:
    return user


@auth_router.patch(&quot;/me/change-password&quot;)
def change_password(
    change_password: ChangePassword,
    session=Depends(get_session),
    current=Depends(get_current_user),
):
    found_user = session.get(User, current.id)
    if not found_user:
        raise HTTPException(status_code=404, detail=&quot;User not found&quot;)
    verified = verify_password(change_password.old_password, found_user.password)
    if not verified:
        raise HTTPException(status_code=400, detail=&quot;Invalid old password&quot;)
    hashed_pwd = get_password_hash(change_password.new_password)
    found_user.password = hashed_pwd
    session.add(found_user)
    session.commit()
    session.refresh(found_user)
    return {&quot;status&quot;: 200, &quot;message&quot;: &quot;password changed successfully&quot;}

</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../leetcode/" class="btn btn-neutral float-left" title="Leetcode"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../db/" class="btn btn-neutral float-right" title="Database">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../leetcode/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../db/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
